<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Terima Barang Baru - Pencarian Santri & Scan QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <!-- Library QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            padding: 2rem;
        }
        .search-results {
            background: white;
            border: 1px solid #ddd;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: absolute;
            width: 100%;
            z-index: 50;
        }
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover {
            background-color: #dbeafe;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal > div {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #6B7280;
            cursor: pointer;
            border: none;
            background: none;
        }
        .modal-close-btn:hover {
            color: #374151;
        }
    </style>
</head>
<body>

    <h1 class="text-3xl font-bold mb-6 text-center">Terima Barang Baru</h1>

    <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg relative">
        <label for="searchInput" class="block font-semibold mb-2">Cari Santri (Nama atau No. Registrasi)</label>
        <input type="text" id="searchInput" class="border border-gray-300 rounded-lg p-3 w-full" placeholder="Ketik nama atau nomor registrasi santri..." autocomplete="off" />
        <div id="searchResults" class="search-results hidden"></div>

        <button id="btnOpenScanner" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700">
            <i class="fas fa-qrcode"></i><span>Scan QR Code</span>
        </button>

        <div id="selectedSantri" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
            <h2 class="font-semibold text-lg mb-2">Santri Terpilih:</h2>
            <p><strong>Nama:</strong> <span id="santriName"></span></p>
            <p><strong>No. Registrasi:</strong> <span id="santriRegNo"></span></p>
        </div>
    </div>

    <!-- Modal Scanner -->
    <div id="modalScanner" class="modal" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
        <div>
            <button class="modal-close-btn" id="closeScannerBtn" aria-label="Tutup scanner">&times;</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800">Scan QR Code Santri</h3>
            <div id="qr-reader"></div>
            <p id="qr-result" class="mt-4 font-semibold text-green-700"></p>
        </div>
    </div>

<script>
    // Data simulasi santri
    const santriData = [
        { id: 1, name: 'Ahmad Fauzi', regNo: 'REG001' },
        { id: 2, name: 'Siti Aminah', regNo: 'REG002' },
        { id: 3, name: 'Budi Santoso', regNo: 'REG003' },
        { id: 4, name: 'Dewi Lestari', regNo: 'REG004' }
    ];

    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const btnOpenScanner = document.getElementById('btnOpenScanner');
    const modalScanner = document.getElementById('modalScanner');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    const qrResult = document.getElementById('qr-result');
    const selectedSantriDiv = document.getElementById('selectedSantri');
    const santriNameSpan = document.getElementById('santriName');
    const santriRegNoSpan = document.getElementById('santriRegNo');

    // Fungsi filter santri berdasarkan query
    function filterSantri(query) {
        const q = query.trim().toLowerCase();
        if (!q) return [];
        return santriData.filter(s =>
            s.name.toLowerCase().includes(q) || s.regNo.toLowerCase().includes(q)
        );
    }

    // Render hasil pencarian
    function renderSearchResults(results) {
        if (results.length === 0) {
            searchResults.innerHTML = '<p class="p-3 text-gray-600">Tidak ada data santri ditemukan.</p>';
            searchResults.classList.remove('hidden');
            return;
        }
        searchResults.innerHTML = '';
        results.forEach(santri => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.textContent = `${santri.name} (${santri.regNo})`;
            div.addEventListener('click', () => {
                selectSantri(santri);
                searchResults.classList.add('hidden');
                searchInput.value = `${santri.name} (${santri.regNo})`;
            });
            searchResults.appendChild(div);
        });
        searchResults.classList.remove('hidden');
    }

    // Pilih santri dan tampilkan info
    function selectSantri(santri) {
        santriNameSpan.textContent = santri.name;
        santriRegNoSpan.textContent = santri.regNo;
        selectedSantriDiv.classList.remove('hidden');
    }

    // Event input pencarian teks
    searchInput.addEventListener('input', () => {
        const query = searchInput.value;
        if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }
        const results = filterSantri(query);
        renderSearchResults(results);
    });

    // Tutup dropdown saat klik di luar
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });

    // Buka modal scanner
    btnOpenScanner.addEventListener('click', () => {
        modalScanner.classList.add('show');
        qrResult.textContent = '';
        startScanner();
    });

    // Tutup modal scanner
    closeScannerBtn.addEventListener('click', () => {
        modalScanner.classList.remove('show');
        stopScanner();
    });

    // QR Code scanner instance
    let html5QrcodeScanner;

    function startScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: 250
                },
                qrCodeMessage => {
                    // Ketika QR code terbaca
                    qrResult.textContent = `QR Code terbaca: ${qrCodeMessage}`;
                    // Cari santri berdasarkan kode QR (anggap kode QR adalah nomor registrasi)
                    const santri = santriData.find(s => s.regNo.toLowerCase() === qrCodeMessage.trim().toLowerCase());
                    if (santri) {
                        selectSantri(santri);
                        searchInput.value = `${santri.name} (${santri.regNo})`;
                        // Tutup scanner setelah berhasil
                        modalScanner.classList.remove('show');
                        stopScanner();
                    } else {
                        qrResult.textContent = 'Santri tidak ditemukan untuk kode QR ini.';
                    }
                },
                errorMessage => {
                    // console.log(`QR scan error: ${errorMessage}`);
                }
            ).catch(err => {
                console.error('Gagal memulai scanner:', err);
                qrResult.textContent = 'Gagal mengakses kamera. Pastikan izin kamera diberikan.';
            });
        } else {
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            startScanner();
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().catch(err => {
                console.warn('Gagal menghentikan scanner:', err);
            });
        }
    }
</script>

</body>
</html>
